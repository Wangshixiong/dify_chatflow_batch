# Dify ChatFlow Batch Tool - 前端需求文档

## 1. 项目概述

### 1.1 项目背景
基于现有的 Dify ChatFlow 批量测试命令行工具，开发一个 Web 前端界面，为用户提供可视化的测试管理和执行体验。

### 1.2 项目目标
- 提供直观的 Web 界面替代命令行操作
- 支持配置文件的可视化管理和持久化存储
- 实现测试用例的上传、编辑和模板下载
- 提供实时的测试执行监控和进度展示
- 支持测试结果的查看和多格式导出

### 1.3 目标用户
- 单用户本地使用场景
- 需要进行 Dify ChatFlow 应用测试的开发者和测试人员

## 2. 功能需求

### 2.1 核心功能模块

#### 2.1.1 配置管理模块
**功能描述**: 管理 API 配置和测试参数设置

**详细需求**:
- 支持多套配置方案的创建、编辑、删除
- 配置项包括:
  - API_URL: Dify API 地址
  - API_KEY: API 密钥（显示时遮蔽）
  - USER_ID: 用户标识
  - TIMEOUT: 超时时间（秒）
  - RESPONSE_MODE: 响应模式
  - LOG_LEVEL: 日志级别
  - OUTPUT_DIR: 输出目录
  - INCLUDE_TIMESTAMP: 是否包含时间戳
- 配置方案的导入/导出功能（.ini 格式）
- 配置的持久化存储（本地存储）
- API 连接测试功能
- 配置切换和应用功能

**验证规则**:
- API_URL 必须是有效的 URL 格式
- API_KEY 不能为空
- TIMEOUT 必须是正整数，范围 10-300 秒
- 输出目录路径验证

#### 2.1.2 测试用例管理模块
**功能描述**: 管理测试用例的上传、编辑和组织

**详细需求**:
- 文件上传功能:
  - 支持拖拽上传和点击选择
  - 支持格式: .csv, .xlsx, .xls
  - 文件大小限制: 10MB
  - 上传进度显示
- 测试用例模板下载
- 用例列表展示:
  - 显示字段: 对话ID、轮次、用户问题、期待回复、状态
  - 支持分页显示（每页 20 条）
  - 支持搜索和筛选
- 用例编辑功能:
  - 单条用例的增删改
  - 批量编辑功能
  - 数据验证和格式检查
- 用例清空和重新上传

**数据格式**:
```
用例字段:
- 对话ID (conversation_id): 字符串，必填
- 轮次 (round): 数字，必填，≥1
- 用户问题 (user_question): 字符串，必填
- 期待回复 (expected_response): 字符串，可选
- inputs: JSON 字符串，可选
```

#### 2.1.3 测试执行模块
**功能描述**: 控制测试执行过程并提供实时监控

**详细需求**:
- 执行控制:
  - 开始测试按钮（需要配置和用例就绪）
  - 暂停/恢复测试
  - 停止测试
  - 重新开始测试
- 实时进度显示:
  - 进度条（百分比和数量）
  - 执行状态（运行中/暂停/停止/完成）
  - 已用时间和预计剩余时间
- 实时日志:
  - 滚动显示执行日志
  - 时间戳 + 操作描述
  - 日志级别区分（信息/警告/错误）
  - 日志清空和导出功能
- 当前响应预览:
  - 显示正在执行的用例
  - 实时显示 AI 响应内容
  - 响应时间统计

#### 2.1.4 结果管理模块
**功能描述**: 展示测试结果和提供导出功能

**详细需求**:
- 统计信息:
  - 总用例数、成功数、失败数、成功率
  - 平均响应时间、最快/最慢响应时间
  - 总执行时间
- 结果列表:
  - 显示所有用例的执行结果
  - 状态标识（成功/失败/跳过）
  - 响应时间显示
  - 错误信息展示
- 结果详情查看:
  - 弹窗显示完整的请求和响应内容
  - 支持复制和搜索
- 导出功能:
  - 支持格式: Excel (.xlsx), CSV, JSON
  - 可选导出范围: 全部/仅成功/仅失败
  - 生成测试报告（PDF，可选）

### 2.2 界面设计

#### 2.2.1 两阶段界面设计
采用两阶段的界面设计，提供清晰的工作流程：

**阶段1: 准备工作台**
- 左侧: 配置管理面板
- 右侧: 测试用例管理面板
- 底部: 准备就绪检查和开始测试按钮

**阶段2: 执行监控台**
- 顶部: 执行控制面板
- 左侧: 实时执行日志
- 右上: 执行结果概览和统计
- 右下: 当前响应预览

#### 2.2.2 界面交互
- 顶部进度指示器显示当前阶段
- 支持在两个阶段间切换
- 响应式设计，适配不同屏幕尺寸
- 友好的错误提示和操作反馈

## 3. 技术需求

### 3.1 前端技术栈
- **框架**: React 18+ 或 Vue 3+
- **UI 组件库**: Ant Design 或 Element Plus
- **状态管理**: Redux Toolkit 或 Pinia
- **路由**: React Router 或 Vue Router
- **HTTP 客户端**: Axios
- **文件处理**: SheetJS (xlsx)
- **实时通信**: WebSocket 或 Server-Sent Events

### 3.2 后端 API 需求
基于现有 Python 后端，需要提供以下 REST API：

#### 3.2.1 配置管理 API
```
GET /api/configs - 获取配置列表
POST /api/configs - 创建新配置
PUT /api/configs/{id} - 更新配置
DELETE /api/configs/{id} - 删除配置
POST /api/configs/{id}/test - 测试配置连接
```

#### 3.2.2 测试用例 API
```
POST /api/testcases/upload - 上传测试用例文件
GET /api/testcases - 获取用例列表
POST /api/testcases - 添加单个用例
PUT /api/testcases/{id} - 更新用例
DELETE /api/testcases/{id} - 删除用例
GET /api/testcases/template - 下载模板文件
```

#### 3.2.3 测试执行 API
```
POST /api/test/start - 开始测试
POST /api/test/pause - 暂停测试
POST /api/test/stop - 停止测试
GET /api/test/status - 获取测试状态
WebSocket /ws/test/progress - 实时进度推送
```

#### 3.2.4 结果管理 API
```
GET /api/results - 获取测试结果
GET /api/results/{id} - 获取结果详情
POST /api/results/export - 导出结果文件
```

### 3.3 数据模型

#### 3.3.1 配置模型
```typescript
interface Config {
  id: string;
  name: string;
  apiUrl: string;
  apiKey: string;
  userId: string;
  timeout: number;
  responseMode: 'streaming' | 'blocking';
  logLevel: 'DEBUG' | 'INFO' | 'WARNING' | 'ERROR';
  outputDir: string;
  includeTimestamp: boolean;
  createdAt: string;
  updatedAt: string;
}
```

#### 3.3.2 测试用例模型
```typescript
interface TestCase {
  id: string;
  conversationId: string;
  round: number;
  userQuestion: string;
  expectedResponse?: string;
  inputs?: string; // JSON string
  status: 'pending' | 'running' | 'success' | 'failed' | 'skipped';
  result?: TestResult;
}

interface TestResult {
  response: string;
  responseTime: number;
  error?: string;
  timestamp: string;
}
```

#### 3.3.3 测试任务模型
```typescript
interface TestTask {
  id: string;
  configId: string;
  status: 'preparing' | 'running' | 'paused' | 'stopped' | 'completed' | 'failed';
  progress: {
    total: number;
    completed: number;
    success: number;
    failed: number;
    current?: string; // 当前执行的用例ID
  };
  startTime?: string;
  endTime?: string;
  statistics: {
    totalTime: number;
    avgResponseTime: number;
    minResponseTime: number;
    maxResponseTime: number;
    successRate: number;
  };
}
```

## 4. 非功能需求

### 4.1 性能要求
- 页面加载时间 < 3秒
- 文件上传支持大文件（10MB）进度显示
- 实时日志更新不影响界面响应性
- 支持 1000+ 测试用例的流畅操作

### 4.2 可用性要求
- 界面简洁直观，新用户 5 分钟内上手
- 提供操作引导和帮助文档
- 错误信息清晰易懂
- 支持键盘快捷键操作

### 4.3 兼容性要求
- 支持主流浏览器：Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
- 响应式设计，支持 1280x720 以上分辨率
- 支持 Windows 10/11 本地部署

### 4.4 数据持久化方案
- **文件存储**: 使用简单的文件存储，无数据库依赖
- **数据目录**: `web/data/` 目录，包含配置文件(.ini)、测试用例(.json)等
- **首次启动**: 自动检测并导入项目根目录的 `config.ini` 作为默认配置
- **完全兼容**: 配置文件格式与现有命令行工具完全一致
- **易于备份**: 直接复制 `web/data/` 目录即可完成数据迁移

### 4.5 安全要求
- **API密钥加密**: 使用 cryptography 库对敏感信息进行轻量级加密存储
- **机器绑定**: 加密密钥与用户机器信息绑定，增加安全性
- **界面遮蔽**: API 密钥在界面显示时进行 `****` 遮蔽
- **输入验证**: 前后端双重验证，后端使用 Pydantic 严格校验
- **文件安全**: 上传文件类型和大小验证，防止恶意文件

## 5. 项目交付

### 5.1 交付物
- 完整的前端应用代码
- 后端 API 接口实现
- 部署文档和用户手册
- 测试用例和测试报告

### 5.2 部署方式
- 本地部署：前后端分离，通过启动脚本运行
- 支持配置文件和数据的本地持久化
- 保持原有命令行功能完全可用
- Web功能作为可选增强功能

### 5.3 项目结构
```
dify_chatflow_batch/
├── src/                            # 🔒 现有命令行代码 (完全不动)
├── examples/                       # 🔒 现有示例 (完全不动)
├── config.ini                      # 🔒 现有配置 (完全不动)
├── requirements.txt                # 🔒 现有依赖 (完全不动)
├── README.md                       # 🔒 现有文档 (完全不动)
└── web/                            # 🆕 新增Web界面目录
    ├── frontend/                   # React + TypeScript + Ant Design
    ├── backend/                    # FastAPI + 复用现有src/模块
    ├── requirements-web.txt        # Web专用依赖
    ├── start.py                    # Web启动脚本
    └── README-web.md               # Web使用说明
```

### 5.4 使用方式
```bash
# 原有命令行 (完全保持)
python src/main.py examples/sample_test_cases.xlsx

# 新增Web界面
cd web && python start.py
```

### 5.5 后续扩展
- exe打包支持 (PyInstaller + 前端静态资源)
- 多用户支持和权限管理
- 测试结果的历史记录和对比
- 更多导出格式和自定义报告
- 测试用例的版本管理
- 集成更多 AI 平台的支持

## 6. 验收标准

### 6.1 功能验收
- [ ] 配置管理：创建、编辑、删除、切换配置方案
- [ ] 用例管理：上传文件、编辑用例、下载模板
- [ ] 测试执行：开始、暂停、停止测试，实时进度显示
- [ ] 结果查看：统计信息、结果列表、详情查看、导出功能
- [ ] 界面交互：两阶段切换、响应式布局、错误处理

### 6.2 性能验收
- [ ] 页面加载时间 < 3秒
- [ ] 1000 条用例加载和显示 < 5秒
- [ ] 文件上传进度实时显示
- [ ] 实时日志更新流畅无卡顿

### 6.3 兼容性验收
- [ ] 主流浏览器兼容性测试通过
- [ ] 不同分辨率下界面正常显示
- [ ] 本地部署成功并正常运行

---

**文档版本**: v1.0  
**创建日期**: 2024-01-15  
**最后更新**: 2024-01-15